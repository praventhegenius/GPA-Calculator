<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal GPA Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .grade-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }
        .tab-active {
            border-bottom: 2px solid #4f46e5;
            color: #4f46e5;
        }
        .tab-inactive {
            border-bottom: 2px solid transparent;
            color: #6b7280;
        }
        .german-flag {
            background: linear-gradient(to bottom, #000000 33%, #DD0000 33%, #DD0000 66%, #FFCE00 66%);
        }
        /* Custom Toggle */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #4f46e5;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #4f46e5;
        }
        /* Input hiding for cleaner look */
        .no-spinner::-webkit-inner-spin-button, 
        .no-spinner::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 pb-20">

    <!-- Navigation -->
    <div class="sticky top-0 z-50 bg-white shadow-sm border-b border-slate-200">
        <div class="max-w-5xl mx-auto px-4">
            <div class="flex flex-col sm:flex-row justify-between items-center py-2 sm:py-0 gap-4 sm:gap-0">
                <!-- Tabs -->
                <div class="flex space-x-8 order-2 sm:order-1 w-full sm:w-auto justify-center sm:justify-start">
                    <button onclick="switchTab('calculator')" id="tab-btn-calculator" class="tab-active py-4 px-1 font-medium text-sm flex items-center gap-2 transition-colors">
                        <i class="fas fa-calculator"></i> Calculator
                    </button>
                    <button onclick="switchTab('report')" id="tab-btn-report" class="tab-inactive py-4 px-1 font-medium text-sm flex items-center gap-2 transition-colors">
                        <i class="fas fa-chart-pie"></i> Report Card
                    </button>
                </div>

                <!-- Data Tools -->
                <div class="flex items-center gap-3 order-1 sm:order-2 w-full sm:w-auto justify-center sm:justify-end">
                    <!-- Hidden File Input -->
                    <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="handleFileSelect(event)">
                    
                    <button onclick="document.getElementById('csvInput').click()" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-1.5 rounded border border-slate-300 transition-colors font-medium">
                        <i class="fas fa-file-import mr-1"></i> Import CSV
                    </button>
                    
                    <button onclick="downloadCSV()" class="text-xs bg-indigo-50 hover:bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded border border-indigo-200 transition-colors font-medium">
                        <i class="fas fa-file-export mr-1"></i> Export CSV
                    </button>

                    <div class="h-4 w-px bg-slate-300 mx-1"></div>

                    <button onclick="clearData()" class="text-xs text-red-500 hover:text-red-700 font-medium" title="Reset All">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-5xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        
        <!-- CALCULATOR TAB -->
        <div id="view-calculator" class="space-y-6">
            
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-slate-900">Universal GPA Calculator</h1>
                <p class="mt-2 text-slate-600">Calculate, Convert, and Save your Grades</p>
            </div>

            <!-- CONFIGURATION PANEL -->
            <div class="bg-white shadow-sm rounded-xl border border-slate-200 p-6">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Configuration</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    
                    <!-- Previous History Section -->
                    <div>
                        <label class="flex items-center cursor-pointer mb-4">
                            <div class="relative">
                                <input type="checkbox" id="toggle-prev" class="sr-only peer" onchange="toggleSection('prev')">
                                <div class="block bg-slate-200 w-11 h-6 rounded-full transition-colors peer-checked:bg-indigo-600"></div>
                                <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition transform peer-checked:translate-x-5"></div>
                            </div>
                            <div class="ml-3 text-slate-700 font-medium text-sm">Include Previous History</div>
                        </label>

                        <div id="prev-inputs" class="hidden pl-2 border-l-2 border-indigo-100 space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs text-slate-500 mb-1">Total Credits Earned</label>
                                    <input type="number" id="prev-credits" class="w-full border-slate-300 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g. 89" oninput="saveAndCalc()">
                                </div>
                                <div>
                                    <label class="block text-xs text-slate-500 mb-1">Current CGPA (10 Scale)</label>
                                    <input type="number" id="prev-cgpa" step="0.01" class="w-full border-slate-300 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g. 8.61" oninput="saveAndCalc()">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Future Prediction Section -->
                    <div>
                        <label class="flex items-center cursor-pointer mb-4">
                            <div class="relative">
                                <input type="checkbox" id="toggle-next" class="sr-only peer" onchange="toggleSection('next')">
                                <div class="block bg-slate-200 w-11 h-6 rounded-full transition-colors peer-checked:bg-indigo-600"></div>
                                <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition transform peer-checked:translate-x-5"></div>
                            </div>
                            <div class="ml-3 text-slate-700 font-medium text-sm">Predict Next Semester</div>
                        </label>

                        <div id="next-inputs" class="hidden pl-2 border-l-2 border-indigo-100 space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs text-slate-500 mb-1">Next Sem Credits</label>
                                    <input type="number" id="next-credits" class="w-full border-slate-300 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500" value="24" oninput="saveAndCalc()">
                                </div>
                                <div>
                                    <label class="block text-xs text-slate-500 mb-1">Target GPA</label>
                                    <input type="number" id="next-gpa" step="0.1" class="w-full border-slate-300 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500" value="9.0" oninput="saveAndCalc()">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CURRENT SEMESTER CARD -->
            <div class="bg-white shadow-xl rounded-2xl overflow-hidden border border-slate-200">
                
                <!-- Table Header -->
                <div class="bg-slate-50 px-4 py-3 border-b border-slate-200 grid grid-cols-12 gap-2 text-xs font-semibold text-slate-500 uppercase tracking-wider">
                    <div class="col-span-6 md:col-span-6">Subject Name</div>
                    <div class="col-span-2 md:col-span-2 text-center">Credits</div>
                    <div class="col-span-3 md:col-span-3">Grade</div>
                    <div class="col-span-1 md:col-span-1"></div>
                </div>

                <!-- Dynamic Subject List -->
                <div id="subjects-list" class="divide-y divide-slate-100">
                    <!-- Rows injected by JS -->
                </div>

                <!-- Add Button -->
                <div class="p-4 bg-slate-50 border-t border-slate-200">
                    <button onclick="addNewSubject()" class="w-full py-2 border-2 border-dashed border-slate-300 rounded-lg text-slate-500 hover:border-indigo-500 hover:text-indigo-600 transition-colors flex items-center justify-center gap-2 font-medium text-sm">
                        <i class="fas fa-plus"></i> Add Subject
                    </button>
                </div>

                <!-- Result Footer -->
                <div class="bg-slate-900 text-white p-6 sm:p-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        
                        <!-- 10 Point Scale -->
                        <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700 flex flex-col items-center justify-center relative overflow-hidden group">
                            <span class="text-xs text-slate-400 uppercase tracking-wider font-semibold mb-2 z-10">10-Point Scale</span>
                            <div class="flex items-baseline gap-1 z-10">
                                <span id="res-10" class="text-4xl font-bold text-indigo-400 transition-all group-hover:scale-110">0.00</span>
                                <span class="text-slate-500 text-sm">/ 10</span>
                            </div>
                            <div class="absolute -right-4 -bottom-4 text-8xl text-white opacity-5 font-bold">10</div>
                        </div>

                        <!-- US Scale -->
                        <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700 flex flex-col items-center justify-center relative overflow-hidden group">
                            <span class="text-xs text-slate-400 uppercase tracking-wider font-semibold mb-2 z-10 flex items-center gap-2">
                                <img src="https://flagcdn.com/us.svg" class="w-4 h-3 rounded-sm opacity-80" alt="USA"> US 4.0 Scale
                            </span>
                            <div class="flex items-baseline gap-1 z-10">
                                <span id="res-4" class="text-4xl font-bold text-emerald-400 transition-all group-hover:scale-110">0.00</span>
                                <span class="text-slate-500 text-sm">/ 4.0</span>
                            </div>
                            <div class="absolute -right-4 -bottom-4 text-8xl text-white opacity-5 font-bold">US</div>
                        </div>

                        <!-- German Scale -->
                        <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700 flex flex-col items-center justify-center relative overflow-hidden group">
                            <span class="text-xs text-slate-400 uppercase tracking-wider font-semibold mb-2 z-10 flex items-center gap-2">
                                <div class="w-4 h-3 rounded-sm opacity-80 german-flag"></div> German Scale
                            </span>
                            <div class="flex items-baseline gap-1 z-10">
                                <span id="res-de" class="text-4xl font-bold text-yellow-400 transition-all group-hover:scale-110">0.00</span>
                                <span class="text-slate-500 text-sm"></span>
                            </div>
                            <div class="text-[10px] text-slate-500 mt-1 z-10">Modified Bavarian</div>
                            <div class="absolute -right-4 -bottom-4 text-8xl text-white opacity-5 font-bold">DE</div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- REPORT TAB -->
        <div id="view-report" class="hidden">
            <div class="bg-white shadow-xl rounded-2xl overflow-hidden border border-slate-200">
                <div class="p-6 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                    <div>
                        <h2 class="text-xl font-bold text-slate-900">Academic Report Card</h2>
                        <p class="text-sm text-slate-500">Generated on <span id="report-date"></span></p>
                    </div>
                    <button onclick="window.print()" class="bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 shadow-sm">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Component</th>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Credits</th>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-indigo-600 uppercase tracking-wider bg-indigo-50/50">10-Point</th>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-emerald-600 uppercase tracking-wider bg-emerald-50/50">US 4.0</th>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-amber-600 uppercase tracking-wider bg-amber-50/50">German</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-slate-200" id="report-table-body">
                            <!-- JS populated -->
                        </tbody>
                        <tfoot class="bg-slate-50 font-semibold text-slate-900">
                            <tr class="border-t-2 border-slate-200">
                                <td class="px-6 py-4">Cumulative GPA</td>
                                <td class="px-6 py-4 text-center" id="report-total-credits">0</td>
                                <td class="px-6 py-4 text-center text-indigo-700 bg-indigo-50/50" id="report-total-10">0.00</td>
                                <td class="px-6 py-4 text-center text-emerald-700 bg-emerald-50/50" id="report-total-4">0.00</td>
                                <td class="px-6 py-4 text-center text-amber-700 bg-amber-50/50" id="report-total-de">0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div class="p-6 bg-slate-50 text-xs text-slate-500 grid md:grid-cols-2 gap-4">
                    <div>
                        <p class="font-semibold text-slate-700 mb-2">Grading Scales:</p>
                        <ul class="list-disc pl-4 space-y-1">
                            <li><strong>10-Point:</strong> Standard Academic Scale</li>
                            <li><strong>US 4.0:</strong> S/A=4.0, B=3.5, C=3.0, D=2.5, E=2.0</li>
                            <li><strong>German:</strong> 1 + 3 Ã— (10 - GPA) / (10 - 5)</li>
                        </ul>
                    </div>
                    <div class="text-right flex flex-col justify-end">
                        <p>Keep this report for your records.</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- 1. State Management ---
        let subjects = [];
        let config = {
            includePrev: false,
            prevCredits: 0,
            prevCGPA: 0,
            includeNext: false,
            nextCredits: 24,
            nextTarget: 9.0
        };

        // Grade Mapping
        const gradePoints = {
            'S': { val10: 10, val4: 4.0 },
            'A': { val10: 9, val4: 4.0 },
            'B': { val10: 8, val4: 3.5 },
            'C': { val10: 7, val4: 3.0 },
            'D': { val10: 6, val4: 2.5 },
            'E': { val10: 5, val4: 2.0 },
            'F': { val10: 0, val4: 0.0 }
        };

        // --- 2. Initialization ---
        window.onload = function() {
            loadFromStorage();
            document.getElementById('report-date').textContent = new Date().toLocaleDateString();
        };

        function loadFromStorage() {
            const savedData = localStorage.getItem('gpaData');
            if (savedData) {
                const data = JSON.parse(savedData);
                subjects = data.subjects || [];
                config = data.config || config;
            } else {
                // Default starting rows if empty
                subjects = [
                    { id: Date.now(), name: 'Subject 1', credits: 4, grade: '' },
                    { id: Date.now() + 1, name: 'Subject 2', credits: 3, grade: '' },
                    { id: Date.now() + 2, name: 'Subject 3', credits: 3, grade: '' }
                ];
            }
            syncUI();
            calculate();
        }

        function saveAndCalc() {
            // Update config from inputs
            config.prevCredits = parseFloat(document.getElementById('prev-credits').value) || 0;
            config.prevCGPA = parseFloat(document.getElementById('prev-cgpa').value) || 0;
            config.nextCredits = parseFloat(document.getElementById('next-credits').value) || 0;
            config.nextTarget = parseFloat(document.getElementById('next-gpa').value) || 0;
            
            // Update config from toggles
            config.includePrev = document.getElementById('toggle-prev').checked;
            config.includeNext = document.getElementById('toggle-next').checked;

            saveToStorage();
            calculate();
        }

        function saveToStorage() {
            const data = { subjects, config };
            localStorage.setItem('gpaData', JSON.stringify(data));
        }

        function clearData() {
            if(confirm("Clear all data and reset?")) {
                localStorage.removeItem('gpaData');
                location.reload();
            }
        }

        // --- 3. CSV IMPORT/EXPORT LOGIC ---
        function downloadCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Header
            csvContent += "Row Type,Name / Description,Value / Credits,Grade\n";
            
            // Config Rows
            csvContent += `CONFIG,Include Previous History,${config.includePrev},\n`;
            csvContent += `CONFIG,Previous Credits,${config.prevCredits},\n`;
            csvContent += `CONFIG,Previous CGPA,${config.prevCGPA},\n`;
            csvContent += `CONFIG,Include Next Sem,${config.includeNext},\n`;
            csvContent += `CONFIG,Next Sem Credits,${config.nextCredits},\n`;
            csvContent += `CONFIG,Next Target GPA,${config.nextTarget},\n`;
            
            // Subject Rows
            subjects.forEach(sub => {
                // Escape commas in names if any
                const safeName = sub.name.includes(',') ? `"${sub.name}"` : sub.name;
                csvContent += `SUBJECT,${safeName},${sub.credits},${sub.grade}\n`;
            });

            // Create Download Link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "my_grades_template.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                parseCSV(text);
            };
            reader.readAsText(file);
            // Reset input so same file can be selected again if needed
            event.target.value = '';
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const newSubjects = [];
            
            // Reset config temp (will populate from file)
            const newConfig = { ...config }; 

            lines.forEach((line, index) => {
                if (index === 0) return; // Skip header
                if (!line.trim()) return; // Skip empty lines

                // Simple CSV parser handling quotes
                // This regex splits by comma but ignores commas inside quotes
                const matches = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                // Fallback simple split if regex fails or simple structure
                const cols = line.split(',').map(c => c.trim().replace(/^"|"$/g, '')); // Remove quotes
                
                if (cols.length < 3) return;

                const type = cols[0].toUpperCase();
                const name = cols[1];
                const val1 = cols[2]; // Credits or Config Value
                const val2 = cols[3] || ''; // Grade

                if (type === 'CONFIG') {
                    if (name === 'Include Previous History') newConfig.includePrev = (val1 === 'true');
                    if (name === 'Previous Credits') newConfig.prevCredits = parseFloat(val1) || 0;
                    if (name === 'Previous CGPA') newConfig.prevCGPA = parseFloat(val1) || 0;
                    if (name === 'Include Next Sem') newConfig.includeNext = (val1 === 'true');
                    if (name === 'Next Sem Credits') newConfig.nextCredits = parseFloat(val1) || 24;
                    if (name === 'Next Target GPA') newConfig.nextTarget = parseFloat(val1) || 9.0;
                } 
                else if (type === 'SUBJECT') {
                    newSubjects.push({
                        id: Date.now() + Math.random(),
                        name: name,
                        credits: parseFloat(val1) || 0,
                        grade: val2
                    });
                }
            });

            // Update State
            subjects = newSubjects;
            config = newConfig;
            
            saveToStorage();
            syncUI();
            calculate();
            alert('Data imported successfully!');
        }


        // --- 4. UI Synchronization ---
        function syncUI() {
            // Sync Configuration Inputs
            document.getElementById('toggle-prev').checked = config.includePrev;
            document.getElementById('prev-credits').value = config.prevCredits || '';
            document.getElementById('prev-cgpa').value = config.prevCGPA || '';
            toggleSection('prev', false); // Set visibility without saving

            document.getElementById('toggle-next').checked = config.includeNext;
            document.getElementById('next-credits').value = config.nextCredits || 24;
            document.getElementById('next-gpa').value = config.nextTarget || 9.0;
            toggleSection('next', false);

            renderSubjects();
        }

        function toggleSection(section, shouldSave = true) {
            const checkbox = document.getElementById(`toggle-${section}`);
            const container = document.getElementById(`${section}-inputs`);
            
            if (checkbox.checked) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
            
            if (shouldSave) saveAndCalc();
        }

        // --- 5. Subject List Management ---
        function renderSubjects() {
            const container = document.getElementById('subjects-list');
            container.innerHTML = '';

            subjects.forEach((sub, index) => {
                const row = document.createElement('div');
                row.className = 'px-4 py-3 grid grid-cols-12 gap-2 items-center hover:bg-slate-50 transition-colors group';
                row.innerHTML = `
                    <!-- Name Input -->
                    <div class="col-span-6 md:col-span-6">
                        <input type="text" 
                            value="${sub.name}" 
                            oninput="updateSubject(${index}, 'name', this.value)"
                            class="w-full border-none bg-transparent p-0 text-sm font-medium text-slate-700 placeholder-slate-400 focus:ring-0" 
                            placeholder="Subject Name">
                    </div>

                    <!-- Credits Input -->
                    <div class="col-span-2 md:col-span-2">
                        <input type="number" 
                            value="${sub.credits}" 
                            oninput="updateSubject(${index}, 'credits', this.value)"
                            class="w-full text-center border border-slate-200 rounded py-1 text-sm text-slate-600 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
                            min="0">
                    </div>

                    <!-- Grade Select -->
                    <div class="col-span-3 md:col-span-3">
                        <select 
                            onchange="updateSubject(${index}, 'grade', this.value)"
                            class="grade-select w-full pl-2 pr-6 py-1 text-sm border-slate-200 rounded focus:border-indigo-500 focus:ring-indigo-500 text-slate-700 bg-white">
                            <option value="" ${sub.grade === '' ? 'selected' : ''}>-</option>
                            <option value="S" ${sub.grade === 'S' ? 'selected' : ''}>S (10)</option>
                            <option value="A" ${sub.grade === 'A' ? 'selected' : ''}>A (9)</option>
                            <option value="B" ${sub.grade === 'B' ? 'selected' : ''}>B (8)</option>
                            <option value="C" ${sub.grade === 'C' ? 'selected' : ''}>C (7)</option>
                            <option value="D" ${sub.grade === 'D' ? 'selected' : ''}>D (6)</option>
                            <option value="E" ${sub.grade === 'E' ? 'selected' : ''}>E (5)</option>
                        </select>
                    </div>

                    <!-- Delete Button -->
                    <div class="col-span-1 md:col-span-1 text-right">
                        <button onclick="removeSubject(${index})" class="text-slate-300 hover:text-red-500 transition-colors p-1">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        function addNewSubject() {
            subjects.push({ id: Date.now(), name: '', credits: 3, grade: '' });
            renderSubjects();
            // Focus on the new subject name
            setTimeout(() => {
                const inputs = document.querySelectorAll('#subjects-list input[type="text"]');
                if(inputs.length) inputs[inputs.length - 1].focus();
            }, 50);
            saveToStorage();
        }

        function updateSubject(index, field, value) {
            if (field === 'credits') value = parseFloat(value) || 0;
            subjects[index][field] = value;
            saveToStorage(); // Calculates automatically inside render? No, need explicit calc
            calculate();
        }

        function removeSubject(index) {
            subjects.splice(index, 1);
            renderSubjects();
            saveToStorage();
            calculate();
        }

        // --- 6. Calculations ---
        function calculate() {
            // A. Calculate Current Semester
            let currCredits = 0;
            let currPts10 = 0;
            let currPts4 = 0;

            subjects.forEach(sub => {
                if (sub.grade && gradePoints[sub.grade]) {
                    const cr = sub.credits;
                    currCredits += cr;
                    currPts10 += gradePoints[sub.grade].val10 * cr;
                    currPts4 += gradePoints[sub.grade].val4 * cr;
                }
            });

            const currGPA10 = currCredits > 0 ? (currPts10 / currCredits) : 0;
            const currGPA4 = currCredits > 0 ? (currPts4 / currCredits) : 0;
            const currGerman = convertToGerman(currGPA10);

            // B. Previous Semester
            // We approximate points based on the user's inputted CGPA
            const prevCredits = config.includePrev ? config.prevCredits : 0;
            const prevGPA10 = config.includePrev ? config.prevCGPA : 0;
            const prevPts10 = prevCredits * prevGPA10;
            // Interpolate US GPA for previous history
            const prevGPA4 = interpolateUS(prevGPA10);
            const prevPts4 = prevCredits * prevGPA4;
            const prevGerman = convertToGerman(prevGPA10);

            // C. Next Semester
            const nextCredits = config.includeNext ? config.nextCredits : 0;
            const nextGPA10 = config.includeNext ? config.nextTarget : 0;
            const nextPts10 = nextCredits * nextGPA10;
            const nextGPA4 = interpolateUS(nextGPA10);
            const nextPts4 = nextCredits * nextGPA4;
            const nextGerman = convertToGerman(nextGPA10);

            // D. Totals
            const totalCredits = currCredits + prevCredits + nextCredits;
            const totalPts10 = currPts10 + prevPts10 + nextPts10;
            const totalPts4 = currPts4 + prevPts4 + nextPts4;

            const finalGPA10 = totalCredits > 0 ? (totalPts10 / totalCredits) : 0;
            const finalGPA4 = totalCredits > 0 ? (totalPts4 / totalCredits) : 0;
            const finalGerman = convertToGerman(finalGPA10);

            // Update Display
            updateDisplay(finalGPA10, finalGPA4, finalGerman);
            
            // Update Report Data
            updateReport({
                prev: { active: config.includePrev, credits: prevCredits, gpa10: prevGPA10, gpa4: prevGPA4, german: prevGerman },
                curr: { active: true, credits: currCredits, gpa10: currGPA10, gpa4: currGPA4, german: currGerman },
                next: { active: config.includeNext, credits: nextCredits, gpa10: nextGPA10, gpa4: nextGPA4, german: nextGerman },
                total: { credits: totalCredits, gpa10: finalGPA10, gpa4: finalGPA4, german: finalGerman }
            });
        }

        function updateDisplay(gpa10, gpa4, german) {
            document.getElementById("res-10").textContent = gpa10.toFixed(2);
            document.getElementById("res-4").textContent = gpa4.toFixed(2);
            document.getElementById("res-de").textContent = german.toFixed(2);
            
            const deEl = document.getElementById('res-de');
            // German scale coloring (Lower is better)
            if (german <= 1.5) deEl.className = "text-4xl font-bold text-emerald-500 transition-all group-hover:scale-110";
            else if (german <= 2.5) deEl.className = "text-4xl font-bold text-indigo-500 transition-all group-hover:scale-110";
            else if (german <= 3.5) deEl.className = "text-4xl font-bold text-yellow-500 transition-all group-hover:scale-110";
            else deEl.className = "text-4xl font-bold text-red-500 transition-all group-hover:scale-110";
        }

        // --- 7. Helpers ---
        function convertToGerman(gpa10) {
            if (gpa10 === 0) return 0;
            if (gpa10 < 5) return 5.0;
            if (gpa10 > 10) return 1.0;
            const result = 1 + 3 * ((10 - gpa10) / (10 - 5));
            return parseFloat(result.toFixed(2));
        }

        function interpolateUS(gpa10) {
            if (gpa10 >= 9) return 4.0;
            if (gpa10 >= 8) return 3.5 + ((gpa10 - 8) / 1) * 0.5;
            if (gpa10 >= 7) return 3.0 + ((gpa10 - 7) / 1) * 0.5;
            if (gpa10 >= 6) return 2.5 + ((gpa10 - 6) / 1) * 0.5;
            if (gpa10 >= 5) return 2.0 + ((gpa10 - 5) / 1) * 0.5;
            return 0.0;
        }

        function updateReport(data) {
            const tbody = document.getElementById('report-table-body');
            let rows = '';

            if (data.prev.active) {
                rows += `<tr>
                    <td class="px-6 py-4 text-sm font-medium text-slate-900">Previous History</td>
                    <td class="px-6 py-4 text-center text-sm text-slate-500">${data.prev.credits}</td>
                    <td class="px-6 py-4 text-center text-sm text-slate-700 font-mono">${data.prev.gpa10.toFixed(2)}</td>
                    <td class="px-6 py-4 text-center text-sm text-slate-700 font-mono">${data.prev.gpa4.toFixed(2)}</td>
                    <td class="px-6 py-4 text-center text-sm text-slate-700 font-mono">${data.prev.german.toFixed(2)}</td>
                </tr>`;
            }

            rows += `<tr class="bg-indigo-50/30">
                <td class="px-6 py-4 text-sm font-medium text-indigo-900">Current Semester</td>
                <td class="px-6 py-4 text-center text-sm text-slate-500">${data.curr.credits}</td>
                <td class="px-6 py-4 text-center text-sm text-indigo-700 font-bold font-mono">${data.curr.gpa10.toFixed(2)}</td>
                <td class="px-6 py-4 text-center text-sm text-emerald-700 font-bold font-mono">${data.curr.gpa4.toFixed(2)}</td>
                <td class="px-6 py-4 text-center text-sm text-amber-700 font-bold font-mono">${data.curr.german.toFixed(2)}</td>
            </tr>`;

            if (data.next.active) {
                rows += `<tr class="bg-slate-50 border-l-4 border-dashed border-l-slate-300">
                    <td class="px-6 py-4 text-sm font-medium text-slate-500 italic">Projected Next Sem</td>
                    <td class="px-6 py-4 text-center text-sm text-slate-400">${data.next.credits}</td>
                    <td class="px-6 py-4 text-center text-sm text-slate-500 font-mono">${data.next.gpa10.toFixed(2)}</td>
                    <td class="px-6 py-4 text-center text-sm text-slate-500 font-mono">${data.next.gpa4.toFixed(2)}</td>
                    <td class="px-6 py-4 text-center text-sm text-slate-500 font-mono">${data.next.german.toFixed(2)}</td>
                </tr>`;
            }

            tbody.innerHTML = rows;
            
            document.getElementById('report-total-credits').textContent = data.total.credits;
            document.getElementById('report-total-10').textContent = data.total.gpa10.toFixed(2);
            document.getElementById('report-total-4').textContent = data.total.gpa4.toFixed(2);
            document.getElementById('report-total-de').textContent = data.total.german.toFixed(2);
        }

        function switchTab(tabName) {
            const calcBtn = document.getElementById('tab-btn-calculator');
            const repBtn = document.getElementById('tab-btn-report');
            const calcView = document.getElementById('view-calculator');
            const repView = document.getElementById('view-report');

            if(tabName === 'calculator') {
                calcBtn.className = "tab-active py-4 px-1 font-medium text-sm flex items-center gap-2 transition-colors";
                repBtn.className = "tab-inactive py-4 px-1 font-medium text-sm flex items-center gap-2 transition-colors";
                calcView.classList.remove('hidden');
                repView.classList.add('hidden');
            } else {
                repBtn.className = "tab-active py-4 px-1 font-medium text-sm flex items-center gap-2 transition-colors";
                calcBtn.className = "tab-inactive py-4 px-1 font-medium text-sm flex items-center gap-2 transition-colors";
                repView.classList.remove('hidden');
                calcView.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
